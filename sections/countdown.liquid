{% if request.design_mode == false %}
  <script type="text/javascript">
      document.addEventListener('DOMContentLoaded', function() {
        var second = 1000,
            minute = second * 60,
            hour = minute * 60,
            day = hour * 24;

        // Gib hier deine feste Redirect-URL an
        var redirectUrl = '{{ section.settings.redirect_url }}';

        var endDateInput = '{{ section.settings.end_date }}';
        var countDownDate = new Date(endDateInput).getTime();

          function formatUnit(unit, singular, plural) {
            return unit === 1 ? singular : plural;
          }

    function updateTimer() {
        var now = new Date().getTime();
        var distance = countDownDate - now;

        if (distance < 0) {
            clearInterval(x); // Stoppt das Intervall

            // Überprüft, ob der Timer abgelaufen ist und leitet unabhängig vom Local Storage-Status weiter
            document.querySelector('.timer').style.display = 'none'; // Blendet den Timer aus

            if (!localStorage.getItem('redirectAfterCountdown')) {
                localStorage.setItem('redirectAfterCountdown', 'true'); // Zustand speichern
            }

            // Weiterleitung zur spezifischen URL
            window.location.href = redirectUrl;
            return;
        } else {
              // Timer-Aktualisierungslogik
              var days = Math.floor(distance / (day));
              var hours = Math.floor((distance % (day)) / (hour));
              var minutes = Math.floor((distance % (hour)) / (minute));
              var seconds = Math.floor((distance % (minute)) / second);

              document.querySelector('.js-timer-days').innerText = days;
              document.querySelector('.js-timer-hours').innerText = hours;
              document.querySelector('.js-timer-minutes').innerText = minutes;
              document.querySelector('.js-timer-seconds').innerText = seconds;

              document.querySelector('.js-timer-days').nextElementSibling.innerText = formatUnit(days, 'Tag', 'Tagen');
              document.querySelector('.js-timer-hours').nextElementSibling.innerText = formatUnit(hours, 'Stunde', 'Stunden');
              document.querySelector('.js-timer-minutes').nextElementSibling.innerText = formatUnit(minutes, 'Minute', 'Minuten');
              document.querySelector('.js-timer-seconds').nextElementSibling.innerText = formatUnit(seconds, 'Sekunde', 'Sekunden');

              // Blenden Sie Teile des Timers basierend auf deren Wert aus
              document.querySelector('.js-timer-days').parentElement.style.display = days === 0 ? 'none' : 'block';
              document.querySelector('.js-timer-hours').parentElement.style.display = hours === 0 ? 'none' : 'block';

              // Setzt die Opazität des Timer-Displays auf 1
              document.querySelector('.timer-display').style.opacity = 1;
            }
          }

          // Setzt die initiale Opazität des Timer-Displays auf 0
          document.querySelector('.timer-display').style.opacity = 0;

          // Initialisiert den Timer sofort und wiederholt die Update-Funktion jede Sekunde
          updateTimer();
          var x = setInterval(updateTimer, second);
        });
  </script>
{% endif %}
<style>
      /* styles for timer */
      .timer {
        background: #f4f4f4;
        padding: 10px;
        text-align: center;
        margin-bottom: 20px;
        border-bottom: 1px solid lightgray;
      }
      .timer-display {
        /* Maximale Breite und Zentrierung des Timers */
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        max-width: 500px;
        margin: auto;
        opacity: 0; /* Timer-Blöcke unsichtbar machen */
        transition: opacity 0.5s ease-in-out; /* Sanfter Einblende-Effekt für Timer-Blöcke */
      }
      .timer-block {
        flex: 1; /* Erlaubt jedem Block, den verfügbaren Platz auszufüllen */
        min-width: 50px; /* Minimale Breite jedes Blocks, um Überfüllung zu verhindern */
        padding: 10px 10px 5px 10px;
        background: white;
        border: 5px solid #f4f4f4;
        border-radius: 10px;
        box-shadow: inset 0px 0px 5px #00000045;
        margin: 5px; /* Fügt einen kleinen Abstand zwischen den Blöcken hinzu */
  }
      .timer-block__num,
      .timer-block__unit {
        display: block;
        text-align: center;
        line-height: 18px;
        font-size: 20px;
        font-family: 'Rajdhani', sans-serif;
        font-weight: 600;
      }
      .timer-block__unit {
        font-size: 14px;
        font-weight: 500;
      }
      .timer-block.hidden {
        display: none; /* Verbirgt Blöcke, die nicht angezeigt werden sollen */
      }
      h4.timer__title {
        margin: 0px;
    }
</style>

{% if section.settings.end_date != blank %}
  <div class="timer">
    {% if section.settings.title != blank %}
      <h4 class="timer__title">{{ section.settings.title }}</h4>
    {% endif %}
    <div class="timer-display">
      <div class="timer-block">
        <span class="timer-block__num js-timer-days">00</span>
        <span class="timer-block__unit">Tage</span>
      </div>
      <div class="timer-block">
        <span class="timer-block__num js-timer-hours">00</span>
        <span class="timer-block__unit">Stunden</span>
      </div>
      <div class="timer-block">
        <span class="timer-block__num js-timer-minutes">00</span>
        <span class="timer-block__unit">Minuten</span>
      </div>
      <div class="timer-block">
        <span class="timer-block__num js-timer-seconds">00</span>
        <span class="timer-block__unit">Sekunden</span>
      </div>
    </div>
  </div>
{% endif %}

{% schema %}
{
  "name": "Countdown | NEU",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Titel",
      "default": "Countdown"
    },
    {
      "type": "text",
      "id": "end_date",
      "label": "Enddatum und -zeit (YYYY-MM-DD HH:MM)",
      "default": "2024-12-31 23:59"
    },
    {
      "type": "text",
      "id": "redirect_url",
      "label": "Weiterleitungs-URL",
      "default": "https://www.beispiel.de"
    }
  ],
  "presets": [
    {
      "name": "Countdown | NEU",
      "category": "Custom"
    }
  ]
}
{% endschema %}
